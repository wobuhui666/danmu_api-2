name: Fork Sync

permissions:
  contents: write

on:
  schedule:
    - cron: "0 0 * * *"  # 每天北京时间早上 8:00 执行
  workflow_dispatch:      # 允许手动点击按钮触发同步

jobs:
  sync_with_upstream:
    name: Sync with Upstream
    runs-on: ubuntu-latest
    if: ${{ github.event.repository.fork }}

    steps:
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          # 关键点：设置为 0 以拉取所有历史记录，防止浅层克隆导致的同步失败
          fetch-depth: 0 

      - name: Sync Upstream
        uses: aormsby/Fork-Sync-With-Upstream-action@v3.4
        with:
          target_repo_token: ${{ secrets.GITHUB_TOKEN }}
          upstream_sync_repo: huangxd-/danmu_api
          upstream_sync_branch: main
          target_sync_branch: main
          test_mode: false
          # 如果之前同步断掉太久，可以开启这个参数强制覆盖（谨慎使用）
          # upstream_pull_args: '--allow-unrelated-histories'

      - name: Check for new commits
        if: success()
        run: echo "✅ Sync completed successfully"

      - name: Check for Failure
        if: failure()
        run: |
          echo "❌ [Error] Sync failed."
          echo "原因可能是：1. 上游 Workflow 变动；2. 存在需要手动处理的冲突；3. 网络波动。"
          echo "如果添加 fetch-depth: 0 后依然失败，建议在网页端手动点一次 Sync Fork。"
          exit 1
